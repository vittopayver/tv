
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Player</title>
<script src="https://cdn.jsdelivr.net/npm/mux.js@6.3.0/dist/mux.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body { width:100%; height:100%; background:#000; overflow:hidden; }
  video { width:100%; height:100%; display:block; background:#000; }
  #erro {
    display:none; position:fixed; inset:0;
    background:#000; color:#ef4444;
    font-family:monospace; font-size:13px;
    align-items:center; justify-content:center;
    flex-direction:column; gap:10px; text-align:center; padding:20px;
  }
  #erro span { color:#64748b; font-size:11px; }
</style>
</head>
<body>

<video id="v" controls autoplay muted playsinline></video>
<div id="erro">
  ⚠ Servidor não respondeu<br>
  <span id="erromsg"></span>
</div>

<script>
/*
  ✅ COMO USAR — leia uma vez só:

  Este arquivo funciona de DUAS formas:

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  FORMA 1 — Abrir direto no Chrome (melhor)
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Salve este arquivo no seu computador e
  abra clicando duas vezes nele.
  O Chrome acessa o stream diretamente.
  Funciona 100% sem nenhuma configuração.

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  FORMA 2 — GitHub Pages (requer proxy)
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Troque a URL abaixo por uma versão https://
  usando Cloudflare Worker ou outro proxy.
*/

const STREAM = 'http://46.151.196.223:14432/';

// ── Setup ────────────────────────────────
const v     = document.getElementById('v');
const erro  = document.getElementById('erro');
const ms    = new MediaSource();
v.src       = URL.createObjectURL(ms);

// ── Abre o MediaSource ───────────────────
ms.addEventListener('sourceopen', async () => {

  // Configura mux.js: converte MPEG-TS → fMP4 fragmentado
  const tx = new muxjs.mp4.Transmuxer({ keepOriginalTimestamps: true });

  // Testa mimetypes em ordem até achar um que o Chrome suporte
  const mimes = [
    'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',
    'video/mp4; codecs="avc1.4d401f, mp4a.40.2"',
    'video/mp4; codecs="avc1.640028, mp4a.40.2"',
    'video/mp4; codecs="avc1.42E01E"',
    'video/mp4',
  ];
  const mime = mimes.find(m => MediaSource.isTypeSupported(m)) || mimes[0];

  let sb;
  try { sb = ms.addSourceBuffer(mime); }
  catch(e) { mostrarErro('Codec não suportado: ' + e.message); return; }
  sb.mode = 'sequence';

  // Fila para não sobrecarregar o buffer
  const fila   = [];
  let ocupado  = false;

  function despachar() {
    if (ocupado || !fila.length || sb.updating) return;
    ocupado = true;
    try { sb.appendBuffer(fila.shift()); }
    catch(e) { ocupado = false; }
  }

  sb.addEventListener('updateend', () => {
    ocupado = false;
    despachar();
    if (v.readyState >= 2 && v.paused) v.play().catch(() => {});
  });

  // mux.js entrega segmentos fMP4 prontos
  tx.on('data', seg => {
    const b = new Uint8Array(seg.initSegment.byteLength + seg.data.byteLength);
    b.set(seg.initSegment, 0);
    b.set(seg.data, seg.initSegment.byteLength);
    fila.push(b.buffer);
    despachar();
  });

  tx.on('done', () => {
    if (!sb.updating) try { ms.endOfStream(); } catch(_) {}
  });

  // ── Fetch do stream ──────────────────────
  try {
    const res = await fetch(STREAM, {
      mode: 'cors',
      headers: { 'Accept': '*/*' }
    });

    if (!res.ok) throw new Error('Servidor retornou HTTP ' + res.status);

    const reader = res.body.getReader();

    // Lê o stream em tempo real e alimenta o mux.js
    while (true) {
      const { done, value } = await reader.read();
      if (done) { tx.flush(); break; }
      tx.push(value);
    }

  } catch(e) {
    mostrarErro(e.message);
  }
});

// ── Remove mudo ao iniciar ───────────────
v.addEventListener('playing', () => {
  setTimeout(() => { v.muted = false; }, 500);
});

// ── Erro de codec/rede no elemento video ─
v.addEventListener('error', () => {
  const msg = {
    2: 'Erro de rede — servidor inacessível',
    3: 'Erro de decodificação do vídeo',
    4: 'Formato não suportado pelo Chrome',
  };
  mostrarErro(msg[v.error?.code] || 'Erro desconhecido');
});

function mostrarErro(msg) {
  erro.style.display  = 'flex';
  document.getElementById('erromsg').textContent = msg;
}
</script>

</body>
</html>
